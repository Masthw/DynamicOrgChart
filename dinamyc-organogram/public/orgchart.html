<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/d3-org-chart@3.1.0"></script>
<script src="https://cdn.jsdelivr.net/npm/d3-flextree@2.1.2/build/d3-flextree.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<link rel="stylesheet" href="src/css/styles.css" />

<script>
  var chart = null;
  let dragNode;
  let dropNode;
  let dragEnabled = false;
  let dragStartX;
  let dragStartY;
  let isDragStarting = false;

  let undoActions = [];
  let redoActions = [];
  let modifiedData = null;
  let originalData = null;

  // Função principal de inicialização
  function initializeChart(data) {
    const chartContainer = document.querySelector('.chart-container');
    if (!chartContainer) {
      console.error(
        'Erro: Contêiner ".chart-container" não encontrado no DOM.'
      );
      return;
    }

    originalData = data;
    modifiedData = [...data];
    initializeFilters(data);
    console.log(data);

    // Configura e renderiza o gráfico de organograma
    chart = new d3.OrgChart()
      .nodeHeight((d) => 85 + 30)
      .nodeWidth((d) => 220 + 35)
      .childrenMargin((d) => 50)
      .compactMarginBetween((d) => 35)
      .compactMarginPair((d) => 30)
      .neighbourMargin((a, b) => 20)
      .nodeContent((d, i, arr, state) => generateContent(d))
      .nodeEnter(function (node) {
        d3.select(this).call(
          d3
            .drag()
            .filter(() => dragEnabled && this.classList.contains('draggable'))
            .on('start', (d, node) => onDragStart(this, d, node))
            .on('drag', (dragEvent, node) => onDrag(this, dragEvent))
            .on('end', (d) => onDragEnd(this, d))
        );
      })
      .nodeUpdate(function (d) {
        d3.select(this).classed('droppable', true).classed('draggable', true);
      })
      .container('.chart-container')
      .data(data)
      .render();

    renderCharts(data);
    addNodeEventListeners();
  }

  function getOrganogramIdFromURL() {
    const hash = window.location.hash; // Captura a parte após o #
    if (!hash) {
      console.error('Hash ausente ou inválido na URL');
      return null;
    }
    const organogramId = hash.substring(1);
    if (/^\d+$/.test(organogramId)) {
      return organogramId;
    }
    console.error('ID inválido encontrado no hash:', organogramId);
    return null;
  }
  // Inicialização do organograma
  document.addEventListener('DOMContentLoaded', () => {
    const organogramId = getOrganogramIdFromURL();
    if (!organogramId) {
      console.error('ID do organograma não encontrado na URL');
      return;
    }

    const savedData = localStorage.getItem(`organogramData_${organogramId}`);
    if (savedData) {
      const data = JSON.parse(savedData);
      initializeChart(data);
    } else {
      d3.csv(
        'https://raw.githubusercontent.com/bumbeishvili/sample-data/main/data-oracle.csv'
      ).then((data) => {
        localStorage.setItem(
          `organogramData_${organogramId}`,
          JSON.stringify(data)
        );
        initializeChart(data);
      });
    }
  });

  function addNodeEventListeners() {
    const buttons = document.querySelectorAll('.node-options-btn');
    buttons.forEach((button) => {
      button.addEventListener('click', (event) => {
        const nodeId = event.target.getAttribute('data-id');
        showOptionsMenu(nodeId);
      });
    });
    chart.render();
  }

  function onDragStart(element, dragEvent, node) {
    dragNode = node;
    const width = dragEvent.subject.width;
    const half = width / 2;
    const x = dragEvent.x - half;
    dragStartX = x;
    dragStartY = parseFloat(dragEvent.y);
    isDragStarting = true;

    d3.select(element).classed('dragging', true);
  }

  function onDrag(element, dragEvent) {
    if (!dragNode) {
      return;
    }

    const state = chart.getChartState();
    const g = d3.select(element);

    if (isDragStarting) {
      isDragStarting = false;
      document
        .querySelector('.chart-container')
        .classList.add('dragging-active');

      // Eleva o nó arrastado para o topo da pilha de renderização (Z-Index)
      g.raise();

      const descendants = dragEvent.subject.descendants();
      const linksToRemove = [...(descendants || []), dragEvent.subject];
      const nodesToRemove = descendants.filter(
        (x) => x.data.id !== dragEvent.subject.id
      );

      state['linksWrapper']
        .selectAll('path.link')
        .data(linksToRemove, (d) => state.nodeId(d))
        .remove();

      if (nodesToRemove) {
        state['nodesWrapper']
          .selectAll('g.node')
          .data(nodesToRemove, (d) => state.nodeId(d))
          .remove();
      }
    }

    dropNode = null;
    const cP = {
      width: dragEvent.subject.width,
      height: dragEvent.subject.height,
      left: dragEvent.x,
      right: dragEvent.x + dragEvent.subject.width,
      top: dragEvent.y,
      bottom: dragEvent.y + dragEvent.subject.height,
      midX: dragEvent.x + dragEvent.subject.width / 2,
      midY: dragEvent.y + dragEvent.subject.height / 2,
    };

    const allNodes = d3.selectAll('g.node:not(.dragging)');
    allNodes.select('rect').attr('fill', 'none');

    allNodes
      .filter(function (d2, i) {
        const cPInner = {
          left: d2.x,
          right: d2.x + d2.width,
          top: d2.y,
          bottom: d2.y + d2.height,
        };

        if (
          cP.midX > cPInner.left &&
          cP.midX < cPInner.right &&
          cP.midY > cPInner.top &&
          cP.midY < cPInner.bottom &&
          this.classList.contains('droppable')
        ) {
          dropNode = d2;
          return d2;
        }
      })
      .select('rect')
      .attr('fill', '#e4e1e1');

    dragStartX += parseFloat(dragEvent.dx);
    dragStartY += parseFloat(dragEvent.dy);
    g.attr('transform', 'translate(' + dragStartX + ',' + dragStartY + ')');
  }

  function onDragEnd(element, dragEvent) {
    document
      .querySelector('.chart-container')
      .classList.remove('dragging-active');

    if (!dragNode) {
      return;
    }

    d3.select(element).classed('dragging', false);

    if (!dropNode) {
      chart.render();
      return;
    }

    if (dragEvent.subject.parent.id === dropNode.id) {
      chart.render();
      return;
    }

    d3.select(element).remove();

    const data = chart.getChartState().data;
    const node = data?.find((x) => x.id === dragEvent.subject.id);
    const oldParentId = node.parentId;
    node.parentId = dropNode.id;

    redoActions = [];
    undoActions.push({
      id: dragEvent.subject.id,
      parentId: oldParentId,
    });

    dropNode = null;
    dragNode = null;
    chart.render();
    updateDragActions();
  }

  function enableDrag() {
    dragEnabled = true;
    document.querySelector('.chart-container').classList.add('drag-enabled');
    document.getElementById('enableDragButton').classList.add('hide');
    document.getElementById('dragActions').classList.remove('hide');
  }

  function disableDrag() {
    dragEnabled = false;
    document.querySelector('.chart-container').classList.remove('drag-enabled');
    document.getElementById('enableDragButton').classList.remove('hide');
    document.getElementById('dragActions').classList.add('hide');
    undoActions = [];
    redoActions = [];
    const organogramId = getOrganogramIdFromURL();
    saveChartState(organogramId);
    updateDragActions();
  }

  function cancelDrag() {
    if (undoActions.length === 0) {
      disableDrag();
      return;
    }

    const data = chart.getChartState().data;
    undoActions.reverse().forEach((action) => {
      const node = data.find((x) => x.id === action.id);
      node.parentId = action.parentId;
    });

    disableDrag();
    chart.render();
  }

  function undo() {
    const action = undoActions.pop();
    if (action) {
      const node = chart.getChartState().data.find((x) => x.id === action.id);
      const currentParentId = node.parentId;
      const previousParentId = action.parentId;
      action.parentId = currentParentId;
      node.parentId = previousParentId;

      redoActions.push(action);
      chart.render();
      updateDragActions();
    }
  }

  function redo() {
    const action = redoActions.pop();
    if (action) {
      const node = chart.getChartState().data.find((x) => x.id === action.id);
      const currentParentId = node.parentId;
      const previousParentId = action.parentId;
      action.parentId = currentParentId;
      node.parentId = previousParentId;
      undoActions.push(action);
      chart.render();
      updateDragActions();
    }
  }

  function updateDragActions() {
    if (undoActions.length > 0) {
      const undoButton = document.getElementById('undoButton');
      undoButton.disabled = false;
    } else {
      undoButton.disabled = true;
    }

    if (redoActions.length > 0) {
      const redoButton = document.getElementById('redoButton');
      redoButton.disabled = false;
    } else {
      redoButton.disabled = true;
    }
  }

  let activeMenu = null;

  function showOptionsMenu(nodeId) {
    const nodeData = chart
      .getChartState()
      .data.find((node) => node.id === nodeId);

    if (!nodeData) {
      return;
    }

    const button = document.querySelector(
      `.node-options-btn[data-id="${nodeId}"]`
    );
    if (!button) {
      return;
    }

    if (activeMenu && activeMenu.button === button) {
      activeMenu.menuElement.remove();
      activeMenu = null;
      return;
    }

    if (activeMenu) {
      activeMenu.menuElement.remove();
      activeMenu = null;
    }

    const existingMenu = button.parentNode.querySelector('.options-menu');
    if (existingMenu) {
      existingMenu.remove();
      return;
    }

    const buttonRect = button.getBoundingClientRect();

    const menuHtml = `
        <div class="options-menu" style="
       position: absolute;
       top: ${buttonRect.bottom + window.scrollY}px;
       left: ${buttonRect.left + window.scrollX}px;
       background: white;
       border: 1px solid #ccc;
       border-radius: 8px;
       box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
       padding: 10px;
       min-width: 150px;
       width: auto;
       z-index: 9999;
     ">
       <div style="margin-bottom: 8px;">
         <button class="info-btn">Informações</button>
       </div>
       <div>
         <button class="add-child-btn">Adicionar</button>
       </div>
     </div>
   `;

    const menuElement = document.createElement('div');
    menuElement.innerHTML = menuHtml;
    document.body.appendChild(menuElement);

    activeMenu = { menuElement, button };

    const infoButton = menuElement.querySelector('.info-btn');
    const addChildButton = menuElement.querySelector('.add-child-btn');

    infoButton.addEventListener('click', () => {
      showPersonInfo(nodeId);
      menuElement.remove();
      activeMenu = null;
    });

    addChildButton.addEventListener('click', () => {
      addChild(nodeId);
      menuElement.remove();
      activeMenu = null;
    });

    document.addEventListener(
      'click',
      (event) => {
        if (!menuElement.contains(event.target) && event.target !== button) {
          menuElement.remove();
          activeMenu = null;
        }
      },
      { once: true }
    );
  }

  function showPersonInfo(nodeId) {
    const person = chart
      .getChartState()
      .data.find((node) => node.id === nodeId);

    if (!person) {
      return;
    }
    const sidebar = document.getElementById('person-info-sidebar');
    const content = document.getElementById('person-info-content');
    const overlay = document.getElementById('overlay');

    document.getElementById('person-photo').src =
      person.image || 'https://via.placeholder.com/50';
    const fullName = `${person.name} ${person.lastName || ''}`;
    document.getElementById('person-name').textContent = fullName;

    const salaryRange = `R$ ${parseFloat(person.job_min_salary).toLocaleString(
      'pt-BR'
    )} - R$ ${parseFloat(person.job_max_salary).toLocaleString('pt-BR')}`;

    const hireDate = new Date(person.hire_date);
    const formattedHireDate = hireDate.toLocaleDateString('pt-BR', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
    });

    const personInfoHtml = `
      <input type="hidden" id="id" value="${person.id}" />
       <div>
         <label>Nome:</label>
         <input type="text" id="name" value="${fullName.trim()}" />
       </div>
       <div>
         <label>Cargo:</label>
         <input type="text" id="position" value="${person.position}" />
       </div>
       <div>
         <label>Email:</label>
         <input type="text" id="email" value="${person.email}" />
       </div>
       <div>
         <label>Telefone:</label>
         <input type="text" id="phone" value="${person.phone_number}" />
       </div>
       <div>
         <label>Salário:</label>
         <input type="text" id="salary" value="${person.salary}" />
       </div>
       <div>
          <div>
      <label>Departamento:</label>
      <input type="text" id="department" value="${person.department_name}" />
    </div>
         <div>
         <label>Faixa Salarial:</label>
         <input type="text" id="salaryRange" value="${salaryRange}" readonly />
       </div>
       <div>
         <label>Data de Contratação:</label>
         <input type="text" id="hireDate" value="${formattedHireDate}" readonly />
       </div>
       </div>
       `;
    content.innerHTML = personInfoHtml;
    sidebar.classList.add('active');
    overlay.classList.add('active');
  }
  document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('close-sidebar').addEventListener('click', () => {
      document.getElementById('person-info-sidebar').classList.remove('active');
      document.getElementById('overlay').classList.remove('active');
    });

    document.getElementById('save-info').addEventListener('click', () => {
      const updatedPerson = {
        id: document.getElementById('id')?.value || '',
        name: document.getElementById('name')?.value.split(' ')[0] || '',
        position: document.getElementById('position')?.value || '',
        email: document.getElementById('email')?.value || '',
        phone_number: document.getElementById('phone')?.value || '',
        salary: document.getElementById('salary')?.value || '',
        department_name: document.getElementById('department')?.value || '',
      };

      const chartData = chart.getChartState().data;
      const personIndex = chartData.findIndex(
        (node) => node.id === updatedPerson.id
      );
      if (personIndex !== -1) {
        chartData[personIndex] = {
          ...chartData[personIndex],
          ...updatedPerson,
        };
        chart.data(chartData).render();
        const organogramId = getOrganogramIdFromURL();
        saveChartState(organogramId);
      }
      document.getElementById('person-info-sidebar').classList.remove('active');
      document.getElementById('overlay').classList.remove('active');
    });

    document.getElementById('delete-person').addEventListener('click', () => {
      const personId = document.getElementById('id').value;
      if (personId) {
        deletePersonWithConditions(personId);
        document
          .getElementById('person-info-sidebar')
          .classList.remove('active');
        document.getElementById('overlay').classList.remove('active');
      }
    });
  });

  function deletePersonWithConditions(nodeId) {
    const chartData = chart.getChartState().data;

    // Encontrar os filhos diretos
    const children = chartData.filter((node) => node.parentId === nodeId);

    if (children.length === 0) {
      // Sem filhos, remover diretamente
      deletePerson(nodeId);
    } else if (children.length === 1) {
      // Apenas um filho, perguntar sobre a promoção
      const confirmPromotion = confirm(
        `Esta pessoa tem um subordinado direto. Deseja promover ${children[0].name} para ocupar o cargo?`
      );
      if (confirmPromotion) {
        deletePerson(nodeId); // A lógica de promoção está incluída na função deletePerson
      }
    } else {
      // Mais de um filho, abrir diálogo para confirmação
      openDeleteDialog(nodeId);
    }
  }

  function openDeleteDialog(nodeId) {
    document.getElementById('deleteDialog').style.display = 'block';
    document.getElementById('deleteOverlay').style.display = 'block';
    populateSubordinatesSelect(nodeId);
  }

  function closeDeleteDialog() {
    document.getElementById('deleteDialog').style.display = 'none';
    document.getElementById('deleteOverlay').style.display = 'none';
  }

  function populateSubordinatesSelect(nodeId) {
    // Limpar o conteúdo atual do select
    const selectElement = document.getElementById('subordinateSelect');
    selectElement.innerHTML =
      '<option value="">Selecione um subordinado</option>';

    // Obter subordinados do nodeId
    const chartData = chart.getChartState().data;
    const children = chartData.filter((node) => node.parentId === nodeId);

    // Adicionar subordinados ao select
    children.forEach((child) => {
      const option = document.createElement('option');
      option.value = child.id;
      option.textContent = child.name;
      selectElement.appendChild(option);
    });
  }

  // Ações no modal de exclusão
  function promoteSubordinates() {
    const selectedSubordinateId =
      document.getElementById('subordinateSelect').value;
    const selectedParentId = document.getElementById('personIdToDelete').value;
    if (selectedSubordinateId && selectedParentId) {
      // Promover o subordinado
      const chartData = chart.getChartState().data;
      const selectedSubordinate = chartData.find(
        (node) => node.id === selectedSubordinateId
      );
      const selectedParent = chartData.find(
        (node) => node.id === selectedParentId
      );

      if (selectedSubordinate && selectedParent) {
        // Chama a função de promoção
        promoteChild(selectedSubordinate, selectedParent);
        closeDeleteDialog(); // Fecha o modal após promoção
      }
    } else {
      alert('Por favor, selecione um subordinado e um chefe para promover.');
    }
  }

  function addNewManager() {
    console.log('Adicionando novo gerente...');
    closeDeleteDialog();
  }

  function closeDepartment() {
    console.log('Encerrando setor...');
    closeDeleteDialog();
  }

  function attachModalEventListeners(nodeId) {
    const chartData = chart.getChartState().data;

    document
      .querySelector(`#delete-modal-${nodeId} .promote-child`)
      .addEventListener('click', () => {
        const selectedChildId = document.querySelector(
          `#delete-modal-${nodeId} .child-selector`
        ).value;
        if (selectedChildId) {
          promoteChild(nodeId, selectedChildId);
          redistributeChildren(nodeId, selectedChildId); // Redistribui os outros filhos
          closeModal(nodeId);
        } else {
          alert('Por favor, selecione um subordinado para promover.');
        }
      });

    document
      .querySelector(`#delete-modal-${nodeId} .add-new-person`)
      .addEventListener('click', () => {
        addNewPerson(nodeId);
        closeModal(nodeId);
      });

    document
      .querySelector(`#delete-modal-${nodeId} .close-department`)
      .addEventListener('click', () => {
        const confirmClose = confirm(
          'Tem certeza de que deseja encerrar este setor e remover todas as pessoas subordinadas?'
        );
        if (confirmClose) {
          deletePerson(nodeId);
          closeModal(nodeId);
        }
      });

    document
      .querySelector(`#delete-modal-${nodeId} .close-modal`)
      .addEventListener('click', () => closeModal(nodeId));
  }

  function closeModal() {
    const modal = document.getElementById(`delete-modal-${nodeId}`);
    if (modal) modal.remove();
  }

  function promoteChild(subordinateId, parentId) {
    const chartData = chart.getChartState().data;

    // Encontrar os nós relevantes no gráfico
    const subordinate = chartData.find((node) => node.id === subordinateId);
    const parent = chartData.find((node) => node.id === parentId);

    if (!subordinate || !parent) {
      alert('Erro ao encontrar as pessoas selecionadas.');
      return;
    }

    // Verificar se a promoção criaria um ciclo
    if (isDescendant(subordinateId, parentId, chartData)) {
      alert('Erro: não é possível promover este nó pois criaria um ciclo.');
      return;
    }

    // Promover o subordinado para ocupar a posição do pai
    subordinate.parentId = parent.parentId;

    // Ajustar os filhos do subordinado para que apontem para ele
    const children = chartData.filter(
      (node) => node.parentId === subordinateId
    );
    children.forEach((child) => {
      child.parentId = subordinate.id;
    });

    // Redesenhar o gráfico com os dados atualizados
    chart.data(chartData).render();
    originalData = [...chartData];

    // Salvar as alterações no localStorage
    const organogramId = getOrganogramIdFromURL();
    saveChartState(organogramId);
  }

  /**
   * Verifica se o nó `potentialAncestorId` é um descendente do nó `nodeId`.
   * Isso ajuda a evitar ciclos.
   */
  function isDescendant(nodeId, potentialAncestorId, chartData) {
    let current = chartData.find((node) => node.id === potentialAncestorId);

    while (current) {
      if (current.parentId === nodeId) {
        return true; // Um ciclo seria criado
      }
      current = chartData.find((node) => node.id === current.parentId);
    }

    return false; // Sem ciclos
  }

  function deletePerson(nodeId) {
    const chartData = chart.getChartState().data;

    const personToDelete = chartData.find((node) => node.id === nodeId);
    if (!personToDelete) {
      alert('Erro: Pessoa não encontrada.');
      return;
    }

    const parentId = personToDelete.parentId;

    const children = chartData.filter((node) => node.parentId === nodeId);

    if (children.length === 1) {
      // Se há apenas um filho, ele assume o lugar da pessoa deletada
      children[0].parentId = parentId;
    } else if (children.length > 1) {
      // Se há mais de um filho, os filhos são promovidos para o nível do avô
      children.forEach((child) => {
        child.parentId = parentId;
      });
    }

    // Remover a pessoa deletada do organograma
    const index = chartData.findIndex((node) => node.id === nodeId);
    if (index !== -1) {
      chartData.splice(index, 1);
    }

    // Atualizar o estado original e salvar no localStorage
    originalData = [...chartData];
    const organogramId = getOrganogramIdFromURL();
    saveChartState(organogramId);

    // Reaplicar os filtros para manter o estado visual consistente
    applyFilters();
  }

  function redistributeChildren(oldParentId, newParentId) {
    const chartData = chart.getChartState().data;

    // Atribuir os filhos do antigo pai para o novo pai
    const children = chartData.filter((node) => node.parentId === oldParentId);
    children.forEach((child) => {
      child.parentId = newParentId;
    });
  }

  function addChild(nodeId) {
    const newChild = {
      id: Date.now().toString(),
      parentId: nodeId,
      //Adicionar informações sobre a pesoa nova para serem editadas, apenas um exemplo abaixo
      name: 'Novo Filho',
      position: 'Cargo Padrão',
      department_name: 'Default Dp',
      image: 'https://via.placeholder.com/150',
    };
    const chartState = chart.getChartState();
    chartState.data.push(newChild);
    chart.data(chartState.data).render();

    const organogramId = getOrganogramIdFromURL();
    saveChartState(organogramId);
  }

  //Filtro
  function getAncestors(
    data,
    nodeId,
    parentIdField = 'parentId',
    idField = 'id'
  ) {
    const ancestors = [];
    let currentId = nodeId;

    while (currentId) {
      const parent = data.find((item) => item[idField] === currentId);
      if (parent) {
        ancestors.push(parent);
        currentId = parent[parentIdField];
      } else {
        break;
      }
    }
    return ancestors;
  }

  function openFilterDialog() {
    document.getElementById('filterDialog').style.display = 'block';
    document.getElementById('modalOverlay').style.display = 'block';
  }

  function closeFilterDialog() {
    document.getElementById('filterDialog').style.display = 'none';
    document.getElementById('modalOverlay').style.display = 'none';
  }

  function applyFilters() {
    const positionFilter = document.getElementById('positionFilter').value;
    const departmentFilter = document.getElementById('departmentFilter').value;
    const locationFilter = document.getElementById('locationFilter').value;

    const filteredNodes = originalData.filter((item) => {
      return (
        (positionFilter === '' || item.position === positionFilter) &&
        (departmentFilter === '' ||
          item.department_name === departmentFilter) &&
        (locationFilter === '' || item.location_state === locationFilter)
      );
    });

    // Adiciona ancestrais de cada nó filtrado
    const ancestors = new Set();
    filteredNodes.forEach((node) => {
      const nodeAncestors = getAncestors(originalData, node.id);
      nodeAncestors.forEach((ancestor) => ancestors.add(ancestor));
    });

    // Converte o Set para array e renderiza
    const filteredDataWithAncestors = [...ancestors];
    chart.data(filteredDataWithAncestors).render();

    const appliedFilters = [];
    if (positionFilter) appliedFilters.push(`Cargo: ${positionFilter}`);
    if (departmentFilter)
      appliedFilters.push(`Departamento: ${departmentFilter}`);
    if (locationFilter) appliedFilters.push(`Local: ${locationFilter}`);

    const appliedFiltersDiv = document.getElementById('appliedFilters');
    if (appliedFilters.length > 0) {
      appliedFiltersDiv.style.display = 'flex';
      appliedFiltersDiv.innerHTML = appliedFilters
        .map(
          (filter) =>
            `<span>${filter} <i onclick="clearSpecificFilter('${filter}')">&times;</i></span>`
        )
        .join('');
    } else {
      appliedFiltersDiv.style.display = 'none';
    }
    closeFilterDialog();
  }

  function clearSpecificFilter(filter) {
    if (filter.startsWith('Cargo:')) {
      document.getElementById('positionFilter').value = '';
    } else if (filter.startsWith('Departamento:')) {
      document.getElementById('departmentFilter').value = '';
    } else if (filter.startsWith('Local:')) {
      document.getElementById('locationFilter').value = '';
    }
    applyFilters();
  }

  function getUniqueValues(data, field) {
    return [
      ...new Set(data.map((item) => item[field]).filter((value) => value)),
    ];
  }

  function populateSelect(selectElement, options) {
    selectElement.innerHTML = '<option value="">Todos</option>';
    options.forEach((option) => {
      const opt = document.createElement('option');
      opt.value = option;
      opt.textContent = option;
      selectElement.appendChild(opt);
    });
  }

  //Adicionar informações relevantes conforme os dados que vierem. Salário, Sigla, Tempo no Cargo, etc.
  function initializeFilters(data) {
    const positionFilter = document.getElementById('positionFilter');
    const departmentFilter = document.getElementById('departmentFilter');
    const locationFilter = document.getElementById('locationFilter');

    const uniquePositions = getUniqueValues(data, 'position');
    const uniqueDepartments = getUniqueValues(data, 'department_name');
    const uniqueLocations = getUniqueValues(data, 'location_state');

    populateSelect(positionFilter, uniquePositions);
    populateSelect(departmentFilter, uniqueDepartments);
    populateSelect(locationFilter, uniqueLocations);
  }

  function clearFilters() {
    // Resetar os valores dos filtros para o estado inicial
    document.getElementById('positionFilter').value = '';
    document.getElementById('departmentFilter').value = '';
    document.getElementById('locationFilter').value = '';

    // Limpar os filtros aplicados na interface
    const appliedFiltersDiv = document.getElementById('appliedFilters');
    appliedFiltersDiv.style.display = 'none';
    appliedFiltersDiv.innerHTML = '';

    // Limpar o array de filtros aplicados
    appliedFilters = [];

    // Reaplicar os filtros (sem nenhum filtro, exibe tudo)
    applyFilters();
  }

  //  gráficos
  let salaryDataOriginal = 0;
  let salaryChartInstance = null;
  function calculateSalaryData(data) {
    return data.reduce(
      (total, person) => total + parseFloat(person.salary || 0),
      0
    );
  }

  function renderCharts(data) {
    salaryDataOriginal = calculateSalaryData(data);
    const ctxSalary = document.getElementById('salaryChart').getContext('2d');
    if (salaryChartInstance) {
      salaryChartInstance.destroy();
    }
    salaryChartInstance = new Chart(ctxSalary, {
      type: 'bar',
      data: {
        labels: ['Salários'],
        datasets: [
          {
            label: 'Custo Total de Salários',
            data: [salaryDataOriginal],
            backgroundColor: ['rgba(75, 192, 192, 0.2)'],
            borderColor: ['rgba(75, 192, 192, 1)'],
            borderWidth: 1,
          },
        ],
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true,
          },
        },
      },
    });
  }

  function saveChartState(id) {
    if (chart) {
      const updatedData = originalData;
      localStorage.setItem(`organogramData_${id}`, JSON.stringify(updatedData));
      renderCharts(updatedData);
    }
  }

  function generateContent(d) {
    const color = '#FFFFFF';
    const imageDiffVert = 25 + 2;
    return `
         <div class="node-container" style='
         width:${d.width}px;
         height:${d.height}px;
         padding-top:${imageDiffVert - 2}px;
         padding-left:1px;
         padding-right:1px'>
                 <div class="content-container" style="font-family: 'Inter', sans-serif;  margin-left:-1px;width:${
                   d.width - 2
                 }px;height:
                 ${d.height - imageDiffVert}px;border-radius:10px;border:
     ${
       d.data._highlighted || d.data._upToTheRootHighlighted
         ? '5px solid #E27396"'
         : '1px solid #E4E2E9"'
     } >
                <div style="display:flex;justify-content:flex-end;margin-top:5px;margin-right:8px;position:relative;">
          <button class="node-options-btn" data-id="${d.data.id}" style="
     background: none;
     border: none;
     font-size: 18px;
     cursor: pointer;
   " onclick="showOptionsMenu('${d.data.id}')">...</button>
         </div>
                     <div  style="margin-top:${
                       -imageDiffVert - 20
                     }px;margin-left:${15}px;border-radius:100px;width:50px;height:50px;" ></div>
                     <div style="margin-top:${-imageDiffVert - 20}px;">
                     <img src="${d.data.image}"
      style="margin-left:${20}px;border-radius:100px;width:40px;height:40px;" /></div>
                     <div style="font-size:15px;color:#08011E;margin-left:5px;margin-top:10px">
                       ${d.data.name}
                       </div>
                       <div style="display: flex; justify-content: space-between; margin-left:5px;margin-right:5px;margin-top:3px; margin-bottom:3px;">
                     <div style="color:#716E7B;font-size:10px;">
                       ${d.data.position}
                       </div>
                       <div style="color:#716E7B; font-size:10px; text-align:right;">
           ${d.data.department_name || 'No Department'}
                         </div>
                     </div>
                 </div>
             </div>
         `;
  }
</script>
<div class="controls">
  <div class="drag-controls">
    <button id="enableDragButton" onclick="enableDrag()">Organizar</button>
    <div id="dragActions" class="hide">
      <button id="finishDrag" onclick="disableDrag()">Salvar</button>
      <button id="undoButton" disabled onclick="undo()">Desfazer</button>
      <button id="redoButton" disabled onclick="redo()">Refazer</button>
      <button id="cancelDrag" onclick="cancelDrag()">Cancelar</button>
    </div>
  </div>
  <div class="right-buttons">
    <button id="filterButton" onclick="openFilterDialog()">Filtros</button>
  </div>
</div>
<div id="appliedFilters" class="applied-filters"></div>
<div class="chart-stats-container">
  <canvas id="salaryChart"></canvas>
</div>

<div class="chart-container"></div>

<div id="person-info-sidebar" class="sidebar hidden">
  <div class="sidebar-header">
    <div style="display: flex; align-items: center">
      <img
        id="person-photo"
        src=""
        alt="Foto da Pessoa"
        style="
          width: 50px;
          height: 50px;
          border-radius: 50%;
          margin-right: 10px;
        "
      />
      <h3 id="person-name">Nome da Pessoa</h3>
    </div>
    <button id="close-sidebar" class="close-btn">&times;</button>
  </div>
  <div id="person-info-content" class="sidebar-content"></div>
  <div class="sidebar-footer">
    <button id="save-info" class="save-btn">Salvar</button>
    <button id="delete-person" class="delete-btn">Excluir</button>
  </div>
</div>
<div id="overlay" class="overlay"></div>

<!-- Filtro -->
<div id="filterDialog" class="modal hidden">
  <div class="modal-content">
    <h3>Aplicar Filtros</h3>
    <div>
      <label for="positionFilter">Cargo:</label>
      <select id="positionFilter">
        <option value="">Todos</option>
      </select>
    </div>
    <div>
      <label for="departmentFilter">Departamento:</label>
      <select id="departmentFilter">
        <option value="">Todos</option>
      </select>
    </div>
    <div>
      <label for="locationFilter">Estado:</label>
      <select id="locationFilter">
        <option value="">Todos</option>
      </select>
    </div>
    <button onclick="applyFilters()">Aplicar</button>
    <button onclick="clearFilters()">Limpar Filtros</button>
    <button onclick="closeFilterDialog()">Fechar</button>
  </div>
</div>
<div id="modalOverlay" class="overlay"></div>
<!-- Modal de Exclusão -->
<div id="deleteDialog" class="modal">
  <div class="modal-content">
    <h3>Excluir Pessoa</h3>
    <p>Esta pessoa possui múltiplos subordinados. Como deseja prosseguir?</p>
    <div id="subordinate-selection-container">
      <label for="subordinateSelect"
        >Selecione um subordinado para promover:</label
      >
      <select id="subordinateSelect">
        <!-- Opções de subordinados serão adicionadas dinamicamente -->
      </select>
    </div>

    <button id="promoteSubordinatesButton">Promover Subordinados</button>
    <button onclick="addNewManager()">Adicionar Novo Gerente</button>
    <button onclick="closeDepartment()">Encerrar Setor</button>
    <button onclick="closeDeleteDialog()">Cancelar</button>
  </div>
</div>
<div id="deleteOverlay" class="overlay"></div>
