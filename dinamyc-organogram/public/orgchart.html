<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/d3-org-chart@3.1.0"></script>
<script src="https://cdn.jsdelivr.net/npm/d3-flextree@2.1.2/build/d3-flextree.js"></script>

<link rel="stylesheet" href="src/css/styles.css" />

<script>
  var chart = null;
  let dragNode;
  let dropNode;
  let dragEnabled = false;
  let dragStartX;
  let dragStartY;
  let isDragStarting = false;
  let undoActions = [];
  let redoActions = [];
  let modifiedData = null;
  let originalData = null;

  function initializeChart(data) {
    const chartContainer = document.querySelector('.chart-container');
    if (!chartContainer) {
      console.error('Erro: Contêiner ".chart-container" não encontrado no DOM.');
      return;
    }

    originalData = data;
    modifiedData = [...data];
    console.log(data);

    chart = new d3.OrgChart()
      .nodeHeight((d) => 125)
      .nodeWidth((d) => 220 + 2)
      .childrenMargin((d) => 100)
      .compactMarginBetween((d) => 85)
      .compactMarginPair((d) => 80)
      .neighbourMargin((a, b) => 60)
      .siblingsMargin((d) => 80)
      .nodeContent((d, i, arr, state) => generateContent(d))
      .buttonContent(({ node, state }) => {
        const totalPeople = node.data._totalSubordinates;
        const totalDepartments = countDepartments(node);
        return `
          <div class="button-content">
            <span class="people">
             <img src="src/assets/icons/person.png"/> ${totalPeople}
            </span>
            <span class="separator">|</span>
            <span class="departments">
             <img src="src/assets/icons/corporate_fare.png"/> ${totalDepartments}
            </span>
          </div>
        `;
      })
      .nodeEnter(function (node) {
        d3.select(this).call(
          d3
            .drag()
            .filter(() => dragEnabled && this.classList.contains('draggable'))
            .on('start', (d, node) => onDragStart(this, d, node))
            .on('drag', (dragEvent, node) => onDrag(this, dragEvent))
            .on('end', (d) => onDragEnd(this, d))
        );
      })
      .nodeUpdate(function (d) {
        d3.select(this).classed('droppable', true).classed('draggable', true);
      })
      .container('.chart-container')
      .data(data)
      .render();
    addNodeEventListeners();
  }

  window.addEventListener('hashchange', () => {
    const orgChartId = getOrgChartIdFromURL();
    if (orgChartId) {
      const savedData = localStorage.getItem(`orgChartData_${orgChartId}`);
      originalData = data;
      modifiedData = [...data];
      initializeChart(data);
    } else {
      console.error(`Dados do organograma com ID ${orgChartId} não encontrados.`);
    }
  });

  window.addEventListener('message', (event) => {
    if (event.data.type === 'updateChart') {
      updateChartData(event.data);
    }
  });
  function updateChartData(data) {
    chart.update();
  }

  function getOrgChartIdFromURL() {
    const hash = window.location.hash;
    if (!hash) {
      console.error('Hash ausente ou inválido na URL');
      return null;
    }
    const orgChartId = hash.substring(1);
    if (/^\d+$/.test(orgChartId)) {
      return orgChartId;
    }
    console.error('ID inválido encontrado no hash:', orgChartId);
    return null;
  }
  // Inicialização do organograma
  document.addEventListener('DOMContentLoaded', () => {
    const orgChartId = getOrgChartIdFromURL();
    if (!orgChartId) {
      console.error('ID do organograma não encontrado na URL');
      return;
    }
    if (orgChartId === '1') {
      const organizeButton = document.getElementById('enableDragButton');
      if (organizeButton) {
        organizeButton.style.display = 'none';
      }
    }
    const orgChartData = getOrgChartData();
    if (orgChartData) {
      initializeChart(orgChartData);
    } else {
      d3.csv('https://raw.githubusercontent.com/bumbeishvili/sample-data/main/data-oracle.csv').then((data) => {
        localStorage.setItem(`orgChartData_${orgChartId}`, JSON.stringify(data));
        initializeChart(data);
      });
    }
  });

  function addNodeEventListeners() {
    const buttons = document.querySelectorAll('.node-options-btn');
    buttons.forEach((button) => {
      button.addEventListener('click', (event) => {
        const nodeId = event.target.getAttribute('data-id');
      });
    });
    chart.render();
  }

  function onDragStart(element, dragEvent, node) {
    dragNode = node;
    const width = dragEvent.subject.width;
    const half = width / 2;
    const x = dragEvent.x - half;
    dragStartX = x;
    dragStartY = parseFloat(dragEvent.y);
    isDragStarting = true;
    d3.select(element).classed('dragging', true);
  }

  function onDrag(element, dragEvent) {
    if (!dragNode) {
      return;
    }
    const state = chart.getChartState();
    const g = d3.select(element);

    if (isDragStarting) {
      isDragStarting = false;
      document.querySelector('.chart-container').classList.add('dragging-active');
      g.raise();

      const descendants = dragEvent.subject.descendants();
      const linksToRemove = [...(descendants || []), dragEvent.subject];
      const nodesToRemove = descendants.filter((x) => x.data.id !== dragEvent.subject.id);
      state['linksWrapper']
        .selectAll('path.link')
        .data(linksToRemove, (d) => state.nodeId(d))
        .remove();

      if (nodesToRemove) {
        state['nodesWrapper']
          .selectAll('g.node')
          .data(nodesToRemove, (d) => state.nodeId(d))
          .remove();
      }
    }
    dropNode = null;
    const cP = {
      width: dragEvent.subject.width,
      height: dragEvent.subject.height,
      left: dragEvent.x,
      right: dragEvent.x + dragEvent.subject.width,
      top: dragEvent.y,
      bottom: dragEvent.y + dragEvent.subject.height,
      midX: dragEvent.x + dragEvent.subject.width / 2,
      midY: dragEvent.y + dragEvent.subject.height / 2,
    };

    const allNodes = d3.selectAll('g.node:not(.dragging)');
    allNodes.select('rect').attr('fill', 'none');

    allNodes
      .filter(function (d2, i) {
        const cPInner = {
          left: d2.x,
          right: d2.x + d2.width,
          top: d2.y,
          bottom: d2.y + d2.height,
        };

        if (
          cP.midX > cPInner.left &&
          cP.midX < cPInner.right &&
          cP.midY > cPInner.top &&
          cP.midY < cPInner.bottom &&
          this.classList.contains('droppable')
        ) {
          dropNode = d2;
          return d2;
        }
      })
      .select('rect')
      .attr('fill', '#e4e1e1');

    dragStartX += parseFloat(dragEvent.dx);
    dragStartY += parseFloat(dragEvent.dy);
    g.attr('transform', 'translate(' + dragStartX + ',' + dragStartY + ')');
  }

  function onDragEnd(element, dragEvent) {
    document.querySelector('.chart-container').classList.remove('dragging-active');
    d3.select(element).classed('dragging', false);

    if (dragEvent.subject.data.name === '?') {
      chart.render();
      return;
    }
    const dropTarget = dropNode;

    if (dropTarget && dropTarget.data) {
      //se já tiver uma pessoa
      if (dropTarget.data.name === '?') {
        window.parent.postMessage(
          {
            type: 'nodeSwapRequest',
            sourceNode: dragEvent.subject.data,
            targetNode: dropTarget.data,
            skipJustifyModal: true,
          },
          '*'
        );
      } else {
        window.parent.postMessage(
          {
            type: 'nodeSwapRequest',
            sourceNode: dragEvent.subject.data,
            targetNode: dropTarget.data,
          },
          '*'
        );
      }
      dropNode = null;
      dragNode = null;
      chart.render();
      return;
    }

    const nodeRect = element.getBoundingClientRect();
    const nodeWidth = nodeRect.width;
    const nodeHeight = nodeRect.height;
    const nodeLeft = nodeRect.left;
    const nodeRight = nodeRect.right;
    const nodeTop = nodeRect.top;
    const nodeBottom = nodeRect.bottom;

    window.parent.postMessage(
      {
        type: 'nodeDropped',
        nodeData: dragEvent.subject.data,
        nodeLeft,
        nodeRight,
        nodeTop,
        nodeBottom,
      },
      '*'
    );

    if (!dropNode || dragEvent.subject.parent.id === dropNode.id) {
      chart.render();
      return;
    }

    d3.select(element).remove();

    const data = chart.getChartState().data;
    const node = data?.find((x) => x.id === dragEvent.subject.id);
    const oldParentId = node.parentId;
    node.parentId = dropNode.id;

    redoActions = [];
    undoActions.push({
      id: dragEvent.subject.id,
      parentId: oldParentId,
    });
    dropNode = null;
    dragNode = null;
    chart.render();
    updateDragActions();
  }

  function enableDrag() {
    dragEnabled = true;
    document.querySelector('.chart-container').classList.add('drag-enabled');
    document.getElementById('dragActions').classList.remove('hide');
  }

  function disableDrag(saveState = true) {
    dragEnabled = false;
    document.querySelector('.chart-container').classList.remove('drag-enabled');
    document.getElementById('dragActions').classList.add('hide');
    undoActions = [];
    redoActions = [];

    if (saveState) {
      const orgChartId = getOrgChartIdFromURL();
      saveChartState(orgChartId);
    }
    updateDragActions();
  }

  function cancelDrag() {
    if (undoActions.length === 0) {
      disableDrag(false);
      return;
    }

    const data = chart.getChartState().data;
    undoActions.reverse().forEach((action) => {
      const node = data.find((x) => x.id === action.id);
      node.parentId = action.parentId;
    });
    disableDrag(false);
    chart.render();
  }

  function undo() {
    const action = undoActions.pop();
    if (action) {
      const node = chart.getChartState().data.find((x) => x.id === action.id);
      const currentParentId = node.parentId;
      const previousParentId = action.parentId;
      action.parentId = currentParentId;
      node.parentId = previousParentId;
      redoActions.push(action);
      chart.render();
      updateDragActions();
    }
  }

  function redo() {
    const action = redoActions.pop();
    if (action) {
      const node = chart.getChartState().data.find((x) => x.id === action.id);
      const currentParentId = node.parentId;
      const previousParentId = action.parentId;
      action.parentId = currentParentId;
      node.parentId = previousParentId;
      undoActions.push(action);
      chart.render();
      updateDragActions();
    }
  }

  function updateDragActions() {
    if (undoActions.length > 0) {
      const undoButton = document.getElementById('undoButton');
      undoButton.disabled = false;
    } else {
      undoButton.disabled = true;
    }

    if (redoActions.length > 0) {
      const redoButton = document.getElementById('redoButton');
      redoButton.disabled = false;
    } else {
      redoButton.disabled = true;
    }
  }

  function countDepartments(node) {
    const deptSet = new Set();
    function traverse(n) {
      const children = n.children || n._children;
      if (children && children.length) {
        children.forEach((child) => {
          if (child.data && child.data.department_id) {
            deptSet.add(child.data.department_id);
          }
          traverse(child);
        });
      }
    }
    let initialChildren = node.children || node._children;
    if (!initialChildren && node.data && node.data.children) {
      initialChildren = node.data.children;
    }

    if (initialChildren && initialChildren.length) {
      initialChildren.forEach((child) => {
        if (child.data && child.data.department_id) {
          deptSet.add(child.data.department_id);
        }
        traverse(child);
      });
    }
    return deptSet.size;
  }

  function getOrgChartData() {
    const orgChartId = getOrgChartIdFromURL();
    if (!orgChartId) {
      console.error('ID do organograma não encontrado na URL');
      return null;
    }

    const savedData = localStorage.getItem(`orgChartData_${orgChartId}`);
    if (savedData) {
      return JSON.parse(savedData);
    } else {
      return null;
    }
  }

  function getFilterData() {
    const data = getOrgChartData();
    if (!data || !Array.isArray(data)) {
      return { positions: [], departments: [], job_ids: [] };
    }
    const positionsSet = new Set();
    const departmentsMap = new Map();
    const jobIdsSet = new Set();

    data.forEach((item) => {
      if (item.position) {
        positionsSet.add(item.position);
      }
      if (item.department_name) {
        const deptId = item.department_id ? item.department_id : item.department_name;
        if (!departmentsMap.has(deptId)) {
          departmentsMap.set(deptId, {
            id: deptId,
            name: item.department_name,
          });
        }
      }
      if (item.job_id) {
        jobIdsSet.add(item.job_id);
      }
    });

    const positions = Array.from(positionsSet);
    const departments = Array.from(departmentsMap.values());
    const job_ids = Array.from(jobIdsSet);
    return { positions, departments, job_ids };
  }

  function getDepartments() {
    const filterData = getFilterData();
    return filterData.departments || [];
  }

  function openFilterDialog() {
    const filterData = getFilterData();
    window.parent.postMessage(
      {
        type: 'openModal',
        action: 'filter',
        ...filterData,
      },
      '*'
    );
  }

  function getVacancyNodes() {
    if (!chart) return [];

    return chart.data().filter((node) => node.name === '?' || node.type === 'vacancy');
  }

  window.addEventListener('message', function (event) {
    if (event.data && event.data.type === 'getVacancies') {
      const vacancies = getVacancyNodes();
      window.parent.postMessage({ type: 'updateVacancies', vacancies }, '*');
    }
  });

  window.addEventListener('message', function (event) {
    if (event.data && event.data.type === 'updateNodeWithEmployee') {
      const updatedNodeData = event.data.data;
      updateNodeWithEmployee(updatedNodeData);
    }
  });

  function updateNodeWithEmployee(updatedNodeData) {
    if (chart) {
      let nodeFound = false;
      const currentData = chart.data();
      currentData.forEach((node) => {
        if (node.id === updatedNodeData.id) {
          node.name = updatedNodeData.name;
          node.image = updatedNodeData.image;
          node.email = updatedNodeData.email;
          node.lastName = updatedNodeData.lastName;
          node.hire_date = updatedNodeData.hire_date;
          node.type = 'employee';
          nodeFound = true;
        }
      });
      if (nodeFound) {
        chart.data(currentData);
        chart.render();
        saveChartState(getOrgChartIdFromURL());
        Employee(updatedNodeData.id, true);
      } else {
        console.warn('Node não encontrado para atualização:', updatedNodeData.id);
      }
    }
  }

  //Limpar pessoa da vaga
  window.addEventListener('message', function (event) {
    if (event.data && event.data.type === 'nodeCleared') {
      const clearedNodeData = event.data.data;
      updateNodeAsVacancy(clearedNodeData);
    }
  });

  function updateNodeAsVacancy(clearedNodeData) {
    if (chart) {
      let nodeFound = false;

      const currentData = chart.data();
      currentData.forEach((node) => {
        if (node.id === clearedNodeData.id) {
          node.name = '?';
          node.image = 'src/assets/images/add_node.png';
          node.email = '';
          node.lastName = '';
          node.hire_date = '';
          node.type = 'vacancy';
          nodeFound = true;
        }
      });
      if (nodeFound) {
        chart.data(currentData);
        chart.render();
        saveChartState(getOrgChartIdFromURL());
      } else {
        console.warn('Node não encontrado para atualizar:', clearedNodeData.id);
      }
    }
  }

  //Adicionar vaga
  window.addEventListener('message', function (event) {
    if (event.data && event.data.type === 'confirmAddJob') {
      const formData = event.data.data;
      const orgChartId = getOrgChartIdFromURL();
      addNode(formData, orgChartId);
    }
  });

  function addNode(formData, chartID) {
    if (chart) {
      const parentId = formData.nodeId;
      const department_name = formData.job_department_name;
      for (let i = 0; i < formData.vacanciesCount; i++) {
        const newNodeId = String(Date.now() + i);
        const newNode = {
          id: newNodeId,
          parentId: parentId,
          name: '?',
          position: formData.job_title || '',
          image: 'src/assets/images/add_node.png',
          department_name: formData.job_department.name,
          department_id: formData.job_department.id,
          _centered: true,
          type: 'vacancy',
          job_id: formData.job_id,
        };
        chart.addNode(newNode);
        modifiedData.push(newNode);
      }
      chart.data(modifiedData);
      chart.render();
      saveChartState(chartID);
    }
  }

  //REMOVER vaga
  window.addEventListener('message', function (event) {
    if (event.data && event.data.type === 'confirmDeleteVacancy') {
      const nodeId = event.data.nodeId;
      deleteVacancy(nodeId);
    }
  });

  function deleteVacancy(nodeId) {
    if (chart) {
      const nodeIndex = modifiedData.findIndex((node) => String(node.id) === String(nodeId));
      if (nodeIndex !== -1) {
        modifiedData.splice(nodeIndex, 1);
        chart.data(modifiedData);
        chart.render();
        saveChartState(getOrgChartIdFromURL());
      }
    }
  }

  //BUSCA
  window.addEventListener('message', function (event) {
    if (typeof event.data === 'string') {
      const searchTerm = event.data;
      filterChart(searchTerm);
    }
  });

  function filterChart(searchTerm) {
    const value = searchTerm.toLowerCase();
    chart.clearHighlighting();

    const data = chart.data();

    data.forEach((d) => {
      (d._expanded = false), (d._highlighted = false);
    });

    data.forEach((d) => {
      const name = d.name ? d.name.toLowerCase() : '';
      const position = d.position ? d.position.toLowerCase() : '';
      const department = d.department_name ? d.department_name.toLowerCase() : '';

      if (value !== '' && (name.includes(value) || position.includes(value) || department.includes(value))) {
        d._highlighted = true;
        d._expanded = true;
      }
    });
    chart.render().fit();
  }

  function resetView() {
    if (chart.resetZoom) {
      chart.resetZoom();
    } else {
      chart.data(originalData).render().fit();
    }
  }

  function saveChartState(id) {
    if (chart) {
      const updatedData = [...modifiedData];
      updatedData.forEach((d) => {
        delete d._highlighted;
      });
      localStorage.setItem(`orgChartData_${id}`, JSON.stringify(updatedData));
      const orgChartData = getOrgChartData();
      if (orgChartData) {
        const newModifiedDate = new Date().toLocaleDateString();
        window.parent.postMessage(
          {
            type: 'orgchart-modified',
            id: id,
            modifiedDate: newModifiedDate,
          },
          '*'
        );
      } else {
        console.error('Erro ao obter dados do organograma');
      }
    }
  }

  function getNodeColor(d) {
    if (!d.parent) {
      return '#000000';
    } else if (!d.parent.parent) {
      if (!d.data.circleColor) {
        d.data.circleColor = getLeaderColor(d.data.id);
      }
      return d.data.circleColor;
    } else {
      return d.parent.data.circleColor || getNodeColor(d.parent);
    }
  }

  function getLeaderColor(leaderId) {
    const storedColors = JSON.parse(localStorage.getItem('leaderColors')) || {};

    if (storedColors[leaderId]) {
      return storedColors[leaderId];
    }

    const newColor = generateRandomColor();
    storedColors[leaderId] = newColor;
    localStorage.setItem('leaderColors', JSON.stringify(storedColors));
    return newColor;
  }

  function generateRandomColor() {
    const palette = ['#414141', '#D9D9D9', '#0072CE', '#460A78', '#10B12D', '#F58746', '#FF3700', '#BF2900', '#7F1B00'];
    return palette[Math.floor(Math.random() * palette.length)];
  }

  document.querySelectorAll('.node-container').forEach((node) => {
    node.addEventListener('click', (e) => {
      if (e.target.closest('.control-btn')) return;
      const nodeId = node.id;
      window.parent.postMessage(
        {
          type: 'openModal',
          action: 'nodeClick',
          nodeId: nodeId,
        },
        '*'
      );
    });
  });

  function getEmployeeData(nodeId) {
    const data = chart.getChartState().data;
    return data.find((node) => String(node.id) === String(nodeId));
  }

  function Employee(nodeId, isEdit = false) {
    const employee = isEdit ? getEmployeeData(nodeId) : {};
    window.parent.postMessage(
      {
        type: 'openModal',
        action: 'employee',
        nodeId: nodeId,
        employee: employee,
      },
      '*'
    );
  }

  function addDepartment(nodeId) {
    window.parent.postMessage(
      {
        type: 'openModal',
        action: 'addDepartment',
        nodeId: nodeId,
      },
      '*'
    );
  }

  function addJob(nodeId, name) {
    const departments = getDepartments();
    window.parent.postMessage(
      {
        type: 'openModal',
        action: 'addJob',
        nodeId: nodeId,
        name: name,
        departments: departments,
      },
      '*'
    );
  }

  function getChildren(nodeId) {
    const data = chart.getChartState().data;
    const children = data.filter((node) => {
      return String(node.parentId) === String(nodeId);
    });
    return children;
  }

  function viewSuccessionPlan(nodeId) {
    const children = getChildren(nodeId);
    window.parent.postMessage(
      {
        type: 'openModal',
        action: 'viewSuccessionPlan',
        nodeId: nodeId,
        children: children,
      },
      '*'
    );
  }

  //remove e delete
  function deleteNode(nodeId) {
    if (chart) {
      const nodeIndex = modifiedData.findIndex((node) => String(node.id) === String(nodeId));

      if (nodeIndex !== -1) {
        const node = modifiedData[nodeIndex];
        const action = node.name === '?' ? 'deleteVacancy' : 'deleteEmployee';
        window.parent.postMessage(
          {
            type: 'openModal',
            action: action,
            nodeId: nodeId,
            nodeName: node.name,
            position: node.position,
          },
          '*'
        );
      } else {
        console.error(`Node com ID ${nodeId} não encontrado.`);
      }
    }
  }

  function generateContent(d) {
    const orgChartId = getOrgChartIdFromURL();
    const shouldShowButtons = orgChartId !== '1';
    const color = '#FFFFFF';
    const imageDiffVert = 27;
    return `
          <div class="node-container" style='
          width:${d.width}px;
          height:${d.height}px;
          padding-top:${imageDiffVert - 2}px;
          padding-left:1px;
          padding-right:1px'>
                  <div class="content-container"  onclick="Employee(${
                    d.data.id
                  }, true);" style="font-family: 'Inter', sans-serif;  margin-left:-1px;width:${d.width - 2}px;height:${
      d.height - imageDiffVert
    }px;border-radius:10px;border: ${d.data._highlighted || d.data._upToTheRootHighlighted ? '5px solid #ff3700"' : '1px solid #E4E2E9"'}>
                    <div style="display:flex;justify-content:flex-end;margin-top:5px;margin-right:8px"> <div style="width:12px; height:12px; border-radius:50%; background-color:${getNodeColor(
                      d
                    )};">
                      </div>
                    </div>
                      <div  style="margin-top:${-imageDiffVert - 20}px;margin-left:${15}px;border-radius:100px;width:50px;height:50px;" >
                      </div>
                      <div style="margin-top:${-imageDiffVert - 20}px;">
                        <img src=" ${d.data.image}" style="margin-left:${20}px;border-radius:100px;width:40px;height:40px;" />
                      </div>
                      <div style="font-size:15px;color:#08011E;margin-left:20px;margin-top:10px">  ${d.data.name}
                      </div>
                      <div style="color:#716E7B;margin-left:20px;margin-top:3px;font-size:10px;"> ${d.data.position} </div>
                      <div style="color:#716E7B;margin-left:20px;margin-top:3px;font-size:10px;"> ${d.data.job_id} </div>
                      <div style="color:#716E7B;margin-left:20px;margin-top:3px;font-size:10px;"> ${d.data.department_name} </div>
                  </div>
                   ${
                     shouldShowButtons
                       ? `
                   <div class="node-controls">
                     <button class="control-btn" onclick="addJob(${d.data.id}, '${d.data.name}'); event.stopPropagation();">
                       <img src="src/assets/icons/chair.png" alt="Adicionar Vaga" />
                       <span class="tooltip">Adicionar Vaga</span>
                     </button>
                     <button class="control-btn" onclick="Employee(${d.data.id}, false); event.stopPropagation();">
                       <img src="src/assets/icons/person_add.png" alt="Adicionar Empregado" />
                       <span class="tooltip">Adicionar Empregado</span>
                     </button>
                     <button class="control-btn" onclick="addDepartment(${d.data.id}); event.stopPropagation();">
                       <img src="src/assets/icons/domain_add.png" alt="Adicionar Departamento" />
                       <span class="tooltip">Adicionar Departamento</span>
                     </button>
                     <button class="control-btn" onclick="viewSuccessionPlan(${d.data.id}); event.stopPropagation();">
                       <img src="src/assets/icons/lan.png" alt="Ver Plano de Sucessão" />
                       <span class="tooltip">Ver Plano de Sucessão</span>
                     </button>
                      <button class="control-btn" onclick="deleteNode(${d.data.id}); event.stopPropagation();">
                       <img src="src/assets/icons/delete.png" alt="Remove" />
                       <span class="tooltip">Remover</span>
                     </button>
                   </div>
                   `
                       : ''
                   }
                 </div>
      `;
  }
</script>
<div class="controls">
  <div class="left-buttons">
    <button id="enableDragButton" class="icon-button" onclick="enableDrag()">
      <img src="src/assets/icons/map_search.png" alt="Organizar" />
      <span>Organizar</span>
    </button>
    <button id="filterButton" class="icon-button" onclick="openFilterDialog(); event.stopPropagation();">
      <img src="src/assets/icons/lan.png" alt="Filtros" />
      <span class="tooltip">Filtros</span>
    </button>
    <button class="icon-button" onclick="chart.zoomIn()">
      <img src="src/assets/icons/zoom_in.png" alt="Zoom In" />
      <span class="tooltip">Aumentar Zoom</span>
    </button>
    <button class="icon-button" onclick="chart.zoomOut()">
      <img src="src/assets/icons/zoom_out.png" alt="Zoom Out" />
      <span class="tooltip">Diminuir Zoom</span>
    </button>
    <button id="resetViewButton" class="icon-button" onclick="resetView()">Redefinir Visualização</button>
  </div>
</div>
<div id="dragActions" class="hide">
  <button id="finishDrag" class="icon-button" onclick="disableDrag()">Salvar</button>
  <button id="undoButton" class="icon-button" disabled onclick="undo()">Desfazer</button>
  <button id="redoButton" class="icon-button" disabled onclick="redo()">Refazer</button>
  <button id="cancelDrag" class="icon-button" onclick="cancelDrag()">Cancelar</button>
</div>
<div class="chart-container"></div>
<div id="overlay" class="overlay"></div>
<div id="modalOverlay" class="overlay"></div>
