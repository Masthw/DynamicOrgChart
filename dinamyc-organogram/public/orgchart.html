<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/d3-org-chart@3.1.0"></script>
<script src="https://cdn.jsdelivr.net/npm/d3-flextree@2.1.2/build/d3-flextree.js"></script>

<link rel="stylesheet" href="src/css/styles.css" />

<script>
  var chart = null;
  let dragNode;
  let dropNode;
  let dragEnabled = false;
  let dragStartX;
  let dragStartY;
  let isDragStarting = false;

  let undoActions = [];
  let redoActions = [];
  let modifiedData = null;
  let originalData = null;

  function initializeChart(data) {
    const chartContainer = document.querySelector('.chart-container');
    if (!chartContainer) {
      console.error(
        'Erro: Contêiner ".chart-container" não encontrado no DOM.'
      );
      return;
    }

    originalData = data;
    modifiedData = [...data];
    initializeFilters(data);
    console.log(data);

    chart = new d3.OrgChart()
      .nodeHeight((d) => 125)
      .nodeWidth((d) => 220 + 2)
      .childrenMargin((d) => 80)
      .compactMarginBetween((d) => 85)
      .compactMarginPair((d) => 80)
      .neighbourMargin((a, b) => 60)
      .siblingsMargin((d) => 80)
      .nodeContent((d, i, arr, state) => generateContent(d))
      .buttonContent(({ node, state }) => {
        const totalPeople = node.data._totalSubordinates;
        const totalDepartments = countDepartments(node);
        return `
      <div class="button-content">
        <span class="people">
         <img src="src/assets/icons/person.png"/> ${totalPeople}
        </span>
        <span class="separator">|</span>
        <span class="departments">
         <img src="src/assets/icons/corporate_fare.png"/> ${totalDepartments}
        </span>
      </div>
    `;
      })
      .nodeEnter(function (node) {
        d3.select(this).call(
          d3
            .drag()
            .filter(() => dragEnabled && this.classList.contains('draggable'))
            .on('start', (d, node) => onDragStart(this, d, node))
            .on('drag', (dragEvent, node) => onDrag(this, dragEvent))
            .on('end', (d) => onDragEnd(this, d))
        );
      })
      .nodeUpdate(function (d) {
        d3.select(this).classed('droppable', true).classed('draggable', true);
      })
      .container('.chart-container')
      .data(data)
      .render();

    addNodeEventListeners();
  }

  window.addEventListener('hashchange', () => {
    const orgChartId = window.location.hash.substring(1);
    const savedData = localStorage.getItem(`orgChartData_${orgChartId}`);

    if (savedData) {
      const data = JSON.parse(savedData);
      initializeChart(data);
    }
  });

  window.addEventListener('message', (event) => {
    if (event.data.type === 'updateChart') {
      updateChartData(event.data);
    }
  });

  function updateChartData(data) {
    chart.update();
  }

  function getOrgChartIdFromURL() {
    const hash = window.location.hash;
    if (!hash) {
      console.error('Hash ausente ou inválido na URL');
      return null;
    }
    const orgChartId = hash.substring(1);
    if (/^\d+$/.test(orgChartId)) {
      return orgChartId;
    }
    console.error('ID inválido encontrado no hash:', orgChartId);
    return null;
  }
  // Inicialização do organograma
  document.addEventListener('DOMContentLoaded', () => {
    const orgChartId = getOrgChartIdFromURL();
    if (!orgChartId) {
      console.error('ID do organograma não encontrado na URL');
      return;
    }

    const savedData = localStorage.getItem(`orgChartData_${orgChartId}`);
    if (savedData) {
      const data = JSON.parse(savedData);
      initializeChart(data);
    } else {
      d3.csv(
        'https://raw.githubusercontent.com/bumbeishvili/sample-data/main/data-oracle.csv'
      ).then((data) => {
        localStorage.setItem(
          `orgChartData_${orgChartId}`,
          JSON.stringify(data)
        );
        initializeChart(data);
      });
    }
  });

  function addNodeEventListeners() {
    const buttons = document.querySelectorAll('.node-options-btn');
    buttons.forEach((button) => {
      button.addEventListener('click', (event) => {
        const nodeId = event.target.getAttribute('data-id');
      });
    });
    chart.render();
  }

  function onDragStart(element, dragEvent, node) {
    dragNode = node;
    const width = dragEvent.subject.width;
    const half = width / 2;
    const x = dragEvent.x - half;
    dragStartX = x;
    dragStartY = parseFloat(dragEvent.y);
    isDragStarting = true;

    d3.select(element).classed('dragging', true);
  }

  function onDrag(element, dragEvent) {
    if (!dragNode) {
      return;
    }

    const state = chart.getChartState();
    const g = d3.select(element);

    if (isDragStarting) {
      isDragStarting = false;
      document
        .querySelector('.chart-container')
        .classList.add('dragging-active');
      g.raise();

      const descendants = dragEvent.subject.descendants();
      const linksToRemove = [...(descendants || []), dragEvent.subject];
      const nodesToRemove = descendants.filter(
        (x) => x.data.id !== dragEvent.subject.id
      );

      state['linksWrapper']
        .selectAll('path.link')
        .data(linksToRemove, (d) => state.nodeId(d))
        .remove();

      if (nodesToRemove) {
        state['nodesWrapper']
          .selectAll('g.node')
          .data(nodesToRemove, (d) => state.nodeId(d))
          .remove();
      }
    }

    dropNode = null;
    const cP = {
      width: dragEvent.subject.width,
      height: dragEvent.subject.height,
      left: dragEvent.x,
      right: dragEvent.x + dragEvent.subject.width,
      top: dragEvent.y,
      bottom: dragEvent.y + dragEvent.subject.height,
      midX: dragEvent.x + dragEvent.subject.width / 2,
      midY: dragEvent.y + dragEvent.subject.height / 2,
    };

    const allNodes = d3.selectAll('g.node:not(.dragging)');
    allNodes.select('rect').attr('fill', 'none');

    allNodes
      .filter(function (d2, i) {
        const cPInner = {
          left: d2.x,
          right: d2.x + d2.width,
          top: d2.y,
          bottom: d2.y + d2.height,
        };

        if (
          cP.midX > cPInner.left &&
          cP.midX < cPInner.right &&
          cP.midY > cPInner.top &&
          cP.midY < cPInner.bottom &&
          this.classList.contains('droppable')
        ) {
          dropNode = d2;
          return d2;
        }
      })
      .select('rect')
      .attr('fill', '#e4e1e1');

    dragStartX += parseFloat(dragEvent.dx);
    dragStartY += parseFloat(dragEvent.dy);
    g.attr('transform', 'translate(' + dragStartX + ',' + dragStartY + ')');
  }

  function onDragEnd(element, dragEvent) {
    document
      .querySelector('.chart-container')
      .classList.remove('dragging-active');

    if (!dragNode) {
      return;
    }

    d3.select(element).classed('dragging', false);

    if (!dropNode) {
      chart.render();
      return;
    }

    if (dragEvent.subject.parent.id === dropNode.id) {
      chart.render();
      return;
    }

    d3.select(element).remove();

    const data = chart.getChartState().data;
    const node = data?.find((x) => x.id === dragEvent.subject.id);
    const oldParentId = node.parentId;
    node.parentId = dropNode.id;

    redoActions = [];
    undoActions.push({
      id: dragEvent.subject.id,
      parentId: oldParentId,
    });

    dropNode = null;
    dragNode = null;
    chart.render();
    updateDragActions();
  }

  function enableDrag() {
    dragEnabled = true;
    document.querySelector('.chart-container').classList.add('drag-enabled');
    document.getElementById('enableDragButton').classList.add('hide');
    document.getElementById('dragActions').classList.remove('hide');
  }

  function disableDrag(saveState = true) {
    dragEnabled = false;
    document.querySelector('.chart-container').classList.remove('drag-enabled');
    document.getElementById('enableDragButton').classList.remove('hide');
    document.getElementById('dragActions').classList.add('hide');
    undoActions = [];
    redoActions = [];

    if (saveState) {
      const orgChartId = getOrgChartIdFromURL();
      saveChartState(orgChartId);
    }
    updateDragActions();
  }

  function cancelDrag() {
    if (undoActions.length === 0) {
      disableDrag(false);
      return;
    }

    const data = chart.getChartState().data;
    undoActions.reverse().forEach((action) => {
      const node = data.find((x) => x.id === action.id);
      node.parentId = action.parentId;
    });

    disableDrag(false);
    chart.render();
  }

  function undo() {
    const action = undoActions.pop();
    if (action) {
      const node = chart.getChartState().data.find((x) => x.id === action.id);
      const currentParentId = node.parentId;
      const previousParentId = action.parentId;
      action.parentId = currentParentId;
      node.parentId = previousParentId;

      redoActions.push(action);
      chart.render();
      updateDragActions();
    }
  }

  function redo() {
    const action = redoActions.pop();
    if (action) {
      const node = chart.getChartState().data.find((x) => x.id === action.id);
      const currentParentId = node.parentId;
      const previousParentId = action.parentId;
      action.parentId = currentParentId;
      node.parentId = previousParentId;
      undoActions.push(action);
      chart.render();
      updateDragActions();
    }
  }

  function updateDragActions() {
    if (undoActions.length > 0) {
      const undoButton = document.getElementById('undoButton');
      undoButton.disabled = false;
    } else {
      undoButton.disabled = true;
    }

    if (redoActions.length > 0) {
      const redoButton = document.getElementById('redoButton');
      redoButton.disabled = false;
    } else {
      redoButton.disabled = true;
    }
  }

  function countDepartments(node) {
    const deptSet = new Set();
    function traverse(n) {
      const children = n.children || n._children;
      if (children && children.length) {
        children.forEach((child) => {
          if (child.data && child.data.department_id) {
            deptSet.add(child.data.department_id);
          }
          traverse(child);
        });
      }
    }
    let initialChildren = node.children || node._children;
    if (!initialChildren && node.data && node.data.children) {
      initialChildren = node.data.children;
    }

    if (initialChildren && initialChildren.length) {
      initialChildren.forEach((child) => {
        if (child.data && child.data.department_id) {
          deptSet.add(child.data.department_id);
        }
        traverse(child);
      });
    }

    return deptSet.size;
  }

  let activeMenu = null;

  //Filtro
  function getAncestors(
    data,
    nodeId,
    parentIdField = 'parentId',
    idField = 'id'
  ) {
    const ancestors = [];
    let currentId = nodeId;

    while (currentId) {
      const parent = data.find((item) => item[idField] === currentId);
      if (parent) {
        ancestors.push(parent);
        currentId = parent[parentIdField];
      } else {
        break;
      }
    }
    return ancestors;
  }

  function openFilterDialog() {
    document.getElementById('filterDialog').style.display = 'block';
    document.getElementById('modalOverlay').style.display = 'block';
  }

  function closeFilterDialog() {
    document.getElementById('filterDialog').style.display = 'none';
    document.getElementById('modalOverlay').style.display = 'none';
  }

  function applyFilters() {
    const positionFilter = document.getElementById('positionFilter').value;
    const departmentFilter = document.getElementById('departmentFilter').value;
    const locationFilter = document.getElementById('locationFilter').value;

    const filteredNodes = originalData.filter((item) => {
      return (
        (positionFilter === '' || item.position === positionFilter) &&
        (departmentFilter === '' ||
          item.department_name === departmentFilter) &&
        (locationFilter === '' || item.location_state === locationFilter)
      );
    });

    // Adiciona ancestrais de cada nó filtrado
    const ancestors = new Set();
    filteredNodes.forEach((node) => {
      const nodeAncestors = getAncestors(originalData, node.id);
      nodeAncestors.forEach((ancestor) => ancestors.add(ancestor));
    });

    // Converte o Set para array e renderiza
    const filteredDataWithAncestors = [...ancestors];
    chart.data(filteredDataWithAncestors).render();

    const appliedFilters = [];
    if (positionFilter) appliedFilters.push(`Cargo: ${positionFilter}`);
    if (departmentFilter)
      appliedFilters.push(`Departamento: ${departmentFilter}`);
    if (locationFilter) appliedFilters.push(`Local: ${locationFilter}`);

    const appliedFiltersDiv = document.getElementById('appliedFilters');
    if (appliedFilters.length > 0) {
      appliedFiltersDiv.style.display = 'flex';
      appliedFiltersDiv.innerHTML = appliedFilters
        .map(
          (filter) =>
            `<span>${filter} <i onclick="clearSpecificFilter('${filter}')">&times;</i></span>`
        )
        .join('');
    } else {
      appliedFiltersDiv.style.display = 'none';
    }
    closeFilterDialog();
  }

  function clearSpecificFilter(filter) {
    if (filter.startsWith('Cargo:')) {
      document.getElementById('positionFilter').value = '';
    } else if (filter.startsWith('Departamento:')) {
      document.getElementById('departmentFilter').value = '';
    } else if (filter.startsWith('Local:')) {
      document.getElementById('locationFilter').value = '';
    }
    applyFilters();
  }

  function getUniqueValues(data, field) {
    return [
      ...new Set(data.map((item) => item[field]).filter((value) => value)),
    ];
  }

  function populateSelect(selectElement, options) {
    selectElement.innerHTML = '<option value="">Todos</option>';
    options.forEach((option) => {
      const opt = document.createElement('option');
      opt.value = option;
      opt.textContent = option;
      selectElement.appendChild(opt);
    });
  }

  //Adicionar informações relevantes conforme os dados que vierem. Salário, Sigla, Tempo no Cargo, etc.
  function initializeFilters(data) {
    const positionFilter = document.getElementById('positionFilter');
    const departmentFilter = document.getElementById('departmentFilter');
    const locationFilter = document.getElementById('locationFilter');

    const uniquePositions = getUniqueValues(data, 'position');
    const uniqueDepartments = getUniqueValues(data, 'department_name');
    const uniqueLocations = getUniqueValues(data, 'location_state');

    populateSelect(positionFilter, uniquePositions);
    populateSelect(departmentFilter, uniqueDepartments);
    populateSelect(locationFilter, uniqueLocations);
  }

  function clearFilters() {
    document.getElementById('positionFilter').value = '';
    document.getElementById('departmentFilter').value = '';
    document.getElementById('locationFilter').value = '';

    const appliedFiltersDiv = document.getElementById('appliedFilters');
    appliedFiltersDiv.style.display = 'none';
    appliedFiltersDiv.innerHTML = '';

    appliedFilters = [];
    applyFilters();
  }

  //BUSCA
  window.addEventListener('message', function (event) {
    const searchTerm = event.data;
    filterChart(searchTerm);
  });

  function filterChart(searchTerm) {
    const value = searchTerm.toLowerCase();
    chart.clearHighlighting();

    const data = chart.data();

    data.forEach((d) => {
      (d._expanded = false), (d._highlighted = false);
    });

    data.forEach((d) => {
      const name = d.name ? d.name.toLowerCase() : '';
      const position = d.position ? d.position.toLowerCase() : '';
      const department = d.department ? d.department.toLowerCase() : '';

      if (
        value !== '' &&
        (name.includes(value) ||
          position.includes(value) ||
          department.includes(value))
      ) {
        d._highlighted = true;
        d._expanded = true;
      }
    });
    chart.render().fit();
  }

  function resetView() {
    clearFilters();

    if (chart.resetZoom) {
      chart.resetZoom();
    } else {
      chart.data(originalData).render().fit();
    }
  }

  function saveChartState(id) {
    if (chart) {
      const updatedData = originalData;
      updatedData.forEach((d) => {
        delete d._highlighted;
      });
      localStorage.setItem(`orgChartData_${id}`, JSON.stringify(updatedData));
      const newModifiedDate = new Date().toLocaleDateString();
      window.parent.postMessage(
        {
          type: 'orgchart-modified',
          id: id,
          modifiedDate: newModifiedDate,
        },
        '*'
      );
    }
  }

  function getNodeColor(d) {
    if (!d.parent) {
      return '#000000';
    } else if (!d.parent.parent) {
      if (!d.data.circleColor) {
        d.data.circleColor = getLeaderColor(d.data.id);
      }
      return d.data.circleColor;
    } else {
      return d.parent.data.circleColor || getNodeColor(d.parent);
    }
  }

  function getLeaderColor(leaderId) {
    const storedColors = JSON.parse(localStorage.getItem('leaderColors')) || {};

    if (storedColors[leaderId]) {
      return storedColors[leaderId];
    }

    const newColor = generateRandomColor();
    storedColors[leaderId] = newColor;
    localStorage.setItem('leaderColors', JSON.stringify(storedColors));
    return newColor;
  }

  function generateRandomColor() {
    const palette = [
      '#414141',
      '#D9D9D9',
      '#0072CE',
      '#460A78',
      '#10B12D',
      '#F58746',
      '#FF3700',
      '#BF2900',
      '#7F1B00',
    ];
    return palette[Math.floor(Math.random() * palette.length)];
  }

  document.querySelectorAll('.node-container').forEach((node) => {
    node.addEventListener('click', (e) => {
      if (e.target.closest('.control-btn')) return;
      const nodeId = node.id;
      window.parent.postMessage(
        {
          type: 'openModal',
          action: 'nodeClick',
          nodeId: nodeId,
        },
        '*'
      );
    });
  });

  function getEmployeeData(nodeId) {
    const data = chart.getChartState().data;
    return data.find((node) => String(node.id) === String(nodeId));
  }

  function Employee(nodeId, isEdit = false) {
    const employee = isEdit ? getEmployeeData(nodeId) : {};
    window.parent.postMessage(
      {
        type: 'openModal',
        action: 'employee',
        nodeId: nodeId,
        employee: employee,
      },
      '*'
    );
  }

  function addDepartment(nodeId) {
    window.parent.postMessage(
      {
        type: 'openModal',
        action: 'addDepartment',
        nodeId: nodeId,
      },
      '*'
    );
  }

  function addJob(nodeId) {
    window.parent.postMessage(
      {
        type: 'openModal',
        action: 'addJob',
        nodeId: nodeId,
      },
      '*'
    );
  }

  function getChildren(nodeId) {
    const data = chart.getChartState().data;
    console.log('Dados do organograma:', data);

    const children = data.filter((node) => {
      return String(node.parentId) === String(nodeId);
    });

    console.log(`Filhos do nó ${nodeId}:`, children);
    return children;
  }

  function viewSuccessionPlan(nodeId) {
    const children = getChildren(nodeId);
    window.parent.postMessage(
      {
        type: 'openModal',
        action: 'viewSuccessionPlan',
        nodeId: nodeId,
        children: children,
      },
      '*'
    );
  }

  function generateContent(d) {
    const color = '#FFFFFF';
    const imageDiffVert = 27;
    return `
      <div class="node-container" style='
      width:${d.width}px;
      height:${d.height}px;
      padding-top:${imageDiffVert - 2}px;
      padding-left:1px;
      padding-right:1px'>
              <div class="content-container"  onclick="Employee(${
                d.data.id
              }, true);" style="font-family: 'Inter', sans-serif;  margin-left:-1px;width:${
      d.width - 2
    }px;height:${d.height - imageDiffVert}px;border-radius:10px;border: ${
      d.data._highlighted || d.data._upToTheRootHighlighted
        ? '5px solid #ff3700"'
        : '1px solid #E4E2E9"'
    } >
                  <div style="display:flex;justify-content:flex-end;margin-top:5px;margin-right:8px"> <div style="width:12px; height:12px; border-radius:50%; background-color:${getNodeColor(
                    d
                  )};"></div></div>
                  <div  style="margin-top:${
                    -imageDiffVert - 20
                  }px;margin-left:${15}px;border-radius:100px;width:50px;height:50px;" ></div>
                  <div style="margin-top:${
                    -imageDiffVert - 20
                  }px;">   <img src=" ${
      d.data.image
    }" style="margin-left:${20}px;border-radius:100px;width:40px;height:40px;" /></div>
                  <div style="font-size:15px;color:#08011E;margin-left:20px;margin-top:10px">  ${
                    d.data.name
                  } </div>
                  <div style="color:#716E7B;margin-left:20px;margin-top:3px;font-size:10px;"> ${
                    d.data.position
                  } </div>
                    <div style="color:#716E7B;margin-left:20px;margin-top:3px;font-size:10px;"> ${
                      'R$ ' + d.data.salary
                    } </div>

              </div>
      <div class="node-controls">
        <button class="control-btn" onclick="addJob(${d.data.id}, '${
      d.data.name
    }'); event.stopPropagation();">
          <img src="src/assets/icons/chair.png" alt="Adicionar Vaga" />
          <span class="tooltip">Adicionar Vaga</span>
        </button>
        <button class="control-btn" onclick="Employee(${
          d.data.id
        }, false); event.stopPropagation();">
          <img src="src/assets/icons/person_add.png" alt="Adicionar Empregado" />
          <span class="tooltip">Adicionar Empregado</span>
        </button>
        <button class="control-btn" onclick="addDepartment(${
          d.data.id
        }); event.stopPropagation();">
          <img src="src/assets/icons/domain_add.png" alt="Adicionar Departamento" />
          <span class="tooltip">Adicionar Departamento</span>
        </button>
        <button class="control-btn" onclick="viewSuccessionPlan(${
          d.data.id
        }); event.stopPropagation();">
          <img src="src/assets/icons/lan.png" alt="Ver Plano de Sucessão" />
          <span class="tooltip">Ver Plano de Sucessão</span>
        </button>
      </div>
    </div>
  `;
  }
</script>
<div class="controls">
  <div class="left-buttons">
    <!-- Organizar (com ícone antes) -->
    <button id="enableDragButton" onclick="enableDrag()">
      <img src="src/assets/icons/map_search.png" alt="Organizar" />
      Organizar
    </button>
    <!-- Filtro (botão circular) -->
    <button id="filterButton" class="icon-button" onclick="openFilterDialog()">
      <img src="src/assets/icons/lan.png" alt="Filtros" />
      <span class="tooltip">Filtros</span>
    </button>
    <!-- Zoom In -->
    <button class="icon-button" onclick="chart.zoomIn()">
      <img src="src/assets/icons/zoom_in.png" alt="Zoom In" />
      <span class="tooltip">Aumentar Zoom</span>
    </button>
    <!-- Zoom Out -->
    <button class="icon-button" onclick="chart.zoomOut()">
      <img src="src/assets/icons/zoom_out.png" alt="Zoom Out" />
      <span class="tooltip">Diminuir Zoom</span>
    </button>
    <button id="resetViewButton" class="icon-button" onclick="resetView()">
      Redefinir Visualização
    </button>
  </div>
</div>

<div id="dragActions" class="hide">
  <button id="finishDrag" onclick="disableDrag()">Salvar</button>
  <button id="undoButton" disabled onclick="undo()">Desfazer</button>
  <button id="redoButton" disabled onclick="redo()">Refazer</button>
  <button id="cancelDrag" onclick="cancelDrag()">Cancelar</button>
</div>

<div id="appliedFilters" class="applied-filters"></div>
<div class="chart-container"></div>
<div id="overlay" class="overlay"></div>

<!-- Filtro -->
<div id="filterDialog" class="modal hidden">
  <div class="modal-content">
    <h3>Aplicar Filtros</h3>
    <div>
      <label for="positionFilter">Cargo:</label>
      <select id="positionFilter">
        <option value="">Todos</option>
      </select>
    </div>
    <div>
      <label for="departmentFilter">Departamento:</label>
      <select id="departmentFilter">
        <option value="">Todos</option>
      </select>
    </div>
    <div>
      <label for="locationFilter">Estado:</label>
      <select id="locationFilter">
        <option value="">Todos</option>
      </select>
    </div>
    <button onclick="applyFilters()">Aplicar</button>
    <button onclick="clearFilters()">Limpar Filtros</button>
    <button onclick="closeFilterDialog()">Fechar</button>
  </div>
</div>
<div id="modalOverlay" class="overlay"></div>
